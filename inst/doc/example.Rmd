---
title: "NanoSIMS data processing of LANS data in R"
output: html_document
---

The Look@NanoSIMS (short LANS) Matlab module written by Lubos Polerecky (*Polerecky L., Adam B., Milucka J., Musat N., Vagner T. and Kuypers M. M. M. (2012) Look@NanoSIMS - a tool for the analysis of nanoSIMS data in environmental microbiology. Environ. Microbiol. 14, 1009â€“1023.*) makes it easy to process NanoSIMS data and draw regions of interest (ROI). The **lans2r** package provides a convenient interface to import the ROI data generated by LANS into R for those interested in processing and plotting the data in R. This R markdown example demonstrates the basic functionality of the **lans2r** package. Please also consult the package help, e.g. `?load_LANS_summary`.

## Installation

You can install this package directly from [GitHub](https://github.com/sebkopf/lans2r) using the **devtools** package.

```{r, eval=FALSE}
install.packages("devtools")
devtools::install_github('sebkopf/lans2r')
```

## Load data

To load data into R, export it from LANS which creates a folder for each analysis with sub folders **dat** containing the aggregated information about the different ROIs (in text file format) and **mat** containing the raw ion maps (in Matlab file format). Both of these can be imported easily with this package. For easier demonstration **lans2r** bundles a set of 3 analyses (folders `analysis1`, `analysis2` and `analysis3`) with the package sources.

```{r, message=FALSE}
library(lans2r)
folder <- system.file("extdata", "nanosims_data", package = "lans2r") # data base directory
```

### ROI overview data

This loads the ROI overview data for the 3 analyses and assigns some additional information to the analyses (here rather random, column `info`). Since the parameters `quiet=F` indicates that information messages should be provided, it also outputs a summary of the loaded data.

```{r}
data <- 
  load_LANS_summary (
    analysis = c("analysis1", "analysis2", "analysis3"), # the analysis folders
    base_dir = folder, # the data base director
    load_zstacks = T, # whether to load z-stacks as well (have to be exported from LANS!)
    info = c("turtle", "jetpack", "pizza"), # any additional information about the analyses
    quiet = F # output information about the files
  ) 
```

To calculate ratios and abundances, simply specificy which ions you would like to ratio. Note: for convenience, we make use of the pipe operator `%>%` for chaining multiple operations. For more information on the pipe, take a look at the [magrittr package](https://cran.r-project.org/web/packages/magrittr/index.html).

```{r}
source("R/calculations.R")

test <- data %>% 
  calculate_ratios(c("13C", "12C"), c("15N12C", "14N12C"), c("15C", "12C")) %>% # calculate isotope ratios
  calculate_abundances(c("13C", "12C"), c("15N12C", "14N12C"), c("15C", "12C")) # calculate abundances
```


```{r}
data <- data %>% 
  calculate_ratios(c("13C", "12C"), c("15N12C", "14N12C")) %>% # calculate isotope ratios
  calculate_abundances(c("13C", "12C"), c("15N12C", "14N12C")) # calculate abundances
```

#### Overview

Let's take a look at the first couple of rows of the data frame.

```{r}
library(knitr)
data %>% head(n=10) %>% kable()
```

Since this is now in long format so it's easy to have both `value` and the `sigma` error, it's hard to see line by line what is going on, let's look just at `analysis1` and recast the values into a wide format (using package `tidyr` but the older version `reshape2` could achieve the same).

```{r}
library(tidyr)
data %>% 
  filter(plane == "all", analysis == "analysis1") %>% 
  select(-data_type, -sigma) %>% 
  spread(variable, value) %>% 
  kable()
```

#### Plotting

Plot all the data using the *ggplot* package.

```{r, fig.width = 10, fig.height = 8}
library(ggplot2)
data %>% 
  ggplot() +
  aes(size, value, color = paste(analysis, info), shape = plane) + 
  geom_errorbar(aes(ymin = value - 2*sigma, ymax = value + 2*sigma), colour="black", width = 0) +
  geom_point(size=3) + 
    labs(x = expression("ROI size ["*mu*"m"^2*"]"), y="", 
         title = expression("ROI summary (2"*sigma*" error bars, may be smaller than symbols)"),
         color = "Analysis") + 
  facet_wrap(~variable, scales="free", nrow = 2) + 
  theme_bw()
```

Focus in on the combined counts (not the individual planes from the z-stack) and look just at ratios:

```{r, fig.width = 6, fig.height = 6}
last_plot() %+% (data %>% filter(plane == "all", data_type == "ratio"))
```

### Ion maps

Again, loading the ion maps for all 3 analyses.

```{r}
maps <- 
  load_LANS_maps (
    analysis = c("analysis1", "analysis2", "analysis3"),
    base_dir = folder
  ) 
```

The data in these looks similar to the summary data frame except that it is broken out pixel by pixel:

```{r}
maps %>% head(n=10) %>% kable()
```

To make it easier to plot these kind of maps, **lans2r** provides a convenience functoin `plot_maps` but of course this could be adjusted as needed (look at the source code to see how this one is made). By default ion counts are normalized for each ion so they can be visualized on the same scale. 

```{r, fig.width = 12, fig.height = 14}
plot_maps(maps)
```

Focusing in on just one ion, we can ditch the normalization, and let's also not draw ROIs for a direct look. Also, because it's a `ggplot`, all ggplot modifications of the plot are fair game.

```{r, fig.width = 10, fig.height = 8}
plot_maps(maps %>% filter(variable == "14N12C", analysis %in% c("analysis1", "analysis2")), 
          normalize = FALSE, draw_ROIs = FALSE) + 
  theme(legend.position = "right") + labs(fill = "ion count")
```

## Future directions

Note that for plotting maps, *lans2r* does not (yet) support any smoothing so although the `plot_maps` function theoretically supports plotting ratios and abundances as well (which can be calculated from the maps data the same way using `calculate_ratios` and `calculate_abundances`), in practice this does not work so well because individual pixels often have extreme values offsetting proper scaling. This might be part of future expansions if the package sees a lot of use so please email with suggestions if you find it helpful.


